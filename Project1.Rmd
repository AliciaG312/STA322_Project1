---
title: "STA322 Project 1"
author: "Alicia Gong, Annie Lin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
urlcolor: blue 
---

```{r setup, include=FALSE}
library(dplyr)
library(survey)
library(readr)
library(pps)
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r, include=FALSE}
source_data <- read_csv("/Users/aliciagong/Desktop/322Project1/Data/merge_final_v4.csv")
```
# Introduction

## Sample Frame

The sampling frame includes 3142 U.S. counties and equivalents plus District of Columbia, giving 3143 in total. There are two important notes: First, we excluded Guam, Virgin Islands, Puerto Rico, American Samoa, Northern Mariana Islands, and U.S. Minor Outlying Islands from the sampling frame. Second, Connecticut petitioned to replace 8 counties with 9 planning regions as county-equivalent geographic units in 2019, and the U.S. Census Bureau adapted this change in 2023 (see [announcement](https://www.ctdata.org/blog/geographic-resources-for-connecticuts-new-county-equivalent-geography#:~:text=In%202019%2C%20the%20Connecticut%20Office,of%20for%20counties%2C%20this%20year.)). Most Connecticut data are still in county level instead of region level. Therefore, we chose to use county level data for Connecticut in this analysis, although it is not align with the latest U.S. Census Bureau standard. 

## Data

### Population
All the county level population data, except Connecticut's, are from the [2020 decennial population census](https://en.wikipedia.org/wiki/List_of_United_States_counties_and_county_equivalents). Connecticut's county level population data are collected from [Connecticut Demographics](https://www.connecticut-demographics.com/counties_by_population).

### Hispanic Population
The county level Hispanic population data in 2020 and 2010 are downloaded from U.S. Census Bureau's [website](https://data.census.gov/all?q=hispanic+population&g=010XX00US$0500000).

### 2020 Presidential Election
The county level voting data, except Alaska's, are collected from [Politico](https://www.politico.com/2020-election/results/). Alaska's county level data are collected from each county's Wikipedia page. The total voting population is calculated by using number of votes divided by percentage of votes.

### Area
The data on county area in $\ mi^2$ are collected from the [2020 decennial population census](https://en.wikipedia.org/wiki/List_of_United_States_counties_and_county_equivalents). Connecticut's county level area data are collected separately from [National Association of Counties](https://en.wikipedia.org/wiki/List_of_United_States_counties_and_county_equivalents)

## Survey Design
First, we used state as natural stratification. We used proportional allocation to decide the sample sizes within each strata. Then, we applied PPS (probability proportional to size) Systematic Sampling within each strata. 

We decided to sample 300 counties, roughly 1/10 of all counties. We calculated sample size of each strata using $N_h / N = n_h / n$, where $N = 3143$ is the total number of U.S. counties,  $N_h$ is total number of counties in each strata, and $n = 300$ is the total number of sample size. We rounded all sample size to integer.

Then, within each state, we calculated each county's weight using $weights = t_x / (n*x_i)$, where $t_x$ is the total population of each state (strata), $n$ is the sample size of each state (i.e., number of sampled counties calculated using proportional allocation), and $x_i$ is the population of each county.

We used the 'ppssstrat' command in [pps package](https://cran.r-project.org/web/packages/pps/index.html) to help with the sampling process. 'ppssstrat' is a command for Stratified PPS Systematic Sampling, and it does sample by using systematic random sampling with probability proportional to size. Stratified PPS Systematic Sampling selects units at a fixed interval throughout the stratum or sampling frame after a random start, then it chooses the first unit randomly from the entire stratum with probability proportional to size and then treats the stratum observations as a closed loop. 

In systematic PPS sampling, the list of units is first ordered randomly and the cumulative total of the auxiliary variable $x_i$ is calculated. Selection of units then takes place using interval sampling with the interval value calculated by dividing the cumulative total $\sum_{i \in N} x_i$ by the sample size n. This is done by generating a random starting point between zero and the interval value in order to select the first unit. The second random number is generated by adding the interval value to the starting point. This is then used to select the second unit. This process of adding the interval value to the previous random number, and selecting the corresponding units, is repeated until the requisite number of units
has been sampled.

```{r}
# Calculated sample size using proportional allocation.

N = 3143 # total number of counties in the US
n = 300 # total number of sample size
source_data$num_sample_county = (source_data$num_county / N) * 300 # this is n_h
source_data$num_sample_county = round(source_data$num_sample_county)
```

```{r}
# Create unique identifier for county
source_data <- source_data %>%                                       
  group_by(state) %>%
  mutate(state_id = cur_group_id()) 

source_data <- source_data %>% group_by(state) %>% mutate(count = sequence(n())) 

source_data$county_id = 1000 * source_data$state_id + source_data$count
```

```{r}
# Proportional allocation based on size
source_data$weights = source_data$pop_state / (source_data$num_sample_county * source_data$pop_county)  
```

```{r}
# Sampling process
set.seed(0)
source_data <- source_data %>% filter(num_sample_county != 0) # Drop states that have a sample size of 0

source_data <- source_data %>% mutate(total_vote_pop = dem_vote / dem_vote_pct)
source_data$total_vote_pop = round(source_data$total_vote_pop)
source_data$third_vote = source_data$total_vote_pop - source_data$dem_vote - source_data$rep_vote

source_data1 <- read_csv("/Users/aliciagong/Desktop/322Project1/Data/source_data1.csv") # We forgot to include the area data so we added it manually to the source_data.csv.

sort_str<-source_data1[order(source_data1$state),] # Sort by stratum
num_sample_county_vector <- c(6,3,1,7,6,6,1,6,15,4,10,9,9,10,11,6,2,2,1,8,8,8,11,5,9,2,1,2,3,6,10,5,8,7,3,6,4,6,9,24,3,1,13,4,5,7,2) # Vector of the sample size of each state

sample_data <- sort_str[ppssstrat(sort_str$pop_county,sort_str$state,num_sample_county_vector),]
```

```{r}
# Survey design
svydes = svydesign(id =~county_id, strata =~ state, weights =~ weights, fpc = ~num_county, data = sample_data)
options(survey.lonely.psu="adjust")
```


# Questions

### 1. What is an estimate of the average population density per county in the U.S. in 2020?

```{r}
svyratio(~pop_county, ~area, design=svydes)
```

### 2. What is an estimate of the total number of people in the U.S. in 2020 who identify as Hispanic or Latino, any race?

```{r}
svytotal(~ total_hispanic_2020, svydes)
confint(svytotal(~ total_hispanic_2020, svydes))
```

### 3. What is an estimate of the total change in the number of people in the U.S. who identify as Hispanic or Latino, any race, between the 2010 and 2020 censuses?

```{r}
sample_data2 <- sample_data %>% mutate(hispanic_diff = total_hispanic_2020 - total_hispanic_2010)
sample_data2$hispanic_diff[is.na(sample_data2$hispanic_diff)] = 0
svydes2 <- svydesign(id =~ county_id, strata =~ state, weights =~ weights,  fpc = ~num_county, data = sample_data2)
svytotal(~ hispanic_diff, svydes2)
confint(svytotal(~ hispanic_diff, svydes2))
```

### 4. What are estimates of the percentages of people in 2020 in the U.S. who voted Republican? How about Democrat? How about a third party?

To answer this question, we used ratio estimator to estimate the percentage.

```{r}
svyratio(~rep_vote, ~total_vote_pop, svydes)
confint(svyratio(~rep_vote, ~total_vote_pop, svydes))
```

```{r}
svyratio(~dem_vote, ~total_vote_pop, svydes)
confint(svyratio(~dem_vote, ~total_vote_pop, svydes))
```
```{r}
svyratio(~third_vote, ~total_vote_pop, svydes)
```

### 5. Answer one other question that interests you from the data that you could collect from the website.

We estimate percentage of population who did not vote in 2020 election. 

```{r}
sample_data3 <- sample_data2 %>% mutate(no_vote = pop_county - vote_pop, 
                                        no_vote_pct = no_vote / pop_county)
svydes3 <- svydesign(id =~ county_id, strata =~ state, weights =~ weights, fpc = ~num_county, data = sample_data3)
```

```{r}
svytotal(~no_vote, svydes3)
confint(svytotal(~no_vote, svydes3))
total_pop <- sum(source_data$pop_county)
171531886 / total_pop
```

We area also interested in the total population per county.

```{r}
svymean(~ pop_county, svydes)
confint(svymean(~ pop_county, svydes))
```